<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Excel para TXT</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">

  <div class="bg-white shadow-lg rounded-2xl p-8 w-full max-w-lg">
    <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Excel ➝ TXT</h2>

    <div class="space-y-4">
      <!-- Input arquivo -->
      <div>
        <label class="block text-sm font-medium text-gray-600 mb-1">Selecione a planilha:</label>
        <input type="file" id="fileInput" accept=".xlsx,.xls" 
               class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-400 focus:outline-none" />
      </div>

      <!-- Select aba -->
      <div>
        <label for="sheetSelect" class="block text-sm font-medium text-gray-600 mb-1">Escolha a aba:</label>
        <select id="sheetSelect" 
                class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-400 focus:outline-none">
        </select>
      </div>

      <!-- Colunas dinâmicas -->
      <div id="columnsContainer" class="hidden">
        <label class="block text-sm font-medium text-gray-600 mb-2">Escolha as colunas:</label>
        <div id="columnsList" class="grid grid-cols-2 gap-2"></div>
      </div>

      <!-- Botão -->
      <button id="convertBtn" 
              class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
        Converter e Baixar TXT
      </button>
    </div>
  </div>

  <script>
    let workbookGlobal = null;

    // Quando carrega a planilha
    document.getElementById("fileInput").addEventListener("change", function (e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (evt) {
        const data = new Uint8Array(evt.target.result);
        workbookGlobal = XLSX.read(data, { type: "array" });

        // Preenche o select com as abas
        const sheetSelect = document.getElementById("sheetSelect");
        sheetSelect.innerHTML = "";
        workbookGlobal.SheetNames.forEach((name, idx) => {
          const option = document.createElement("option");
          option.value = name;
          option.textContent = name;
          if (idx === 0) option.selected = true;
          sheetSelect.appendChild(option);
        });

        // Carregar colunas da primeira aba por padrão
        loadColumns(workbookGlobal.SheetNames[0]);
      };
      reader.readAsArrayBuffer(file);
    });

    // Quando mudar a aba
    document.getElementById("sheetSelect").addEventListener("change", function () {
      const sheetName = this.value;
      loadColumns(sheetName);
    });

    // Função para encontrar a linha de cabeçalho válida
    function findHeaderRow(rows) {
      for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        // Considera header válido se tiver pelo menos 2 colunas não vazias
        const validCols = row.filter(col => col !== undefined && col !== null && col !== "").length;
        if (validCols >= 2) {
          return i;
        }
      }
      return 0; // fallback
    }

    // Função para carregar colunas
    function loadColumns(sheetName) {
      if (!workbookGlobal) return;

      const sheet = workbookGlobal.Sheets[sheetName];
      const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

      if (rows.length === 0) return;

      const headerRowIndex = findHeaderRow(rows);
      const headers = rows[headerRowIndex]; // linha correta com cabeçalhos
      const columnsList = document.getElementById("columnsList");
      const container = document.getElementById("columnsContainer");

      columnsList.innerHTML = "";
      headers.forEach((header, index) => {
        if (header !== undefined && header !== null && header !== "") {
          const div = document.createElement("div");
          div.className = "flex items-center space-x-2";
          div.innerHTML = `
            <input type="checkbox" class="colCheckbox" value="${index}" id="col${index}">
            <label for="col${index}" class="text-sm text-gray-700">${header}</label>
          `;
          columnsList.appendChild(div);
        }
      });

      container.classList.remove("hidden");
      container.setAttribute("data-header-index", headerRowIndex); // guardar posição do header
    }

    // Quando clicar em converter
    document.getElementById("convertBtn").addEventListener("click", function () {
      if (!workbookGlobal) {
        alert("Selecione uma planilha primeiro!");
        return;
      }

      const sheetName = document.getElementById("sheetSelect").value;
      const sheet = workbookGlobal.Sheets[sheetName];
      const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

      const headerRowIndex = parseInt(document.getElementById("columnsContainer").getAttribute("data-header-index")) || 0;

      // Colunas selecionadas
      const selectedCols = Array.from(document.querySelectorAll(".colCheckbox:checked"))
                               .map(cb => parseInt(cb.value));

      if (selectedCols.length === 0) {
        alert("Selecione pelo menos uma coluna!");
        return;
      }

      let txtContent = "";
      rows.forEach((row, idx) => {
        if (idx <= headerRowIndex) return; // ignora cabeçalhos

        const line = selectedCols.map(colIndex => row[colIndex] !== undefined ? row[colIndex] : "").join(";");
        
        // só exporta se tiver pelo menos um valor real
        if (line.replace(/;/g, "").trim() !== "") {
          txtContent += line + "\n";
        }
      });

      const blob = new Blob([txtContent], { type: "text/plain;charset=utf-8" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = sheetName + "_resultado.txt";
      link.click();
    });
  </script>
</body>
</html>
