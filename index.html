<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Excel para TXT</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
  <div class="bg-white p-6 rounded-2xl shadow-lg w-full max-w-3xl">
    <h2 class="text-2xl font-bold mb-4 text-gray-800">Converter Excel para TXT</h2>
    
    <!-- Upload -->
    <input type="file" id="fileInput" accept=".xlsx,.xls" 
           class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 
                  file:rounded-full file:border-0 file:text-sm file:font-semibold 
                  file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 mb-4"/>

    <!-- Aba -->
    <label class="block text-gray-700 mb-2">Escolha a aba:</label>
    <select id="sheetSelect" class="border rounded-lg p-2 w-full mb-4"></select>

    <!-- Colunas -->
    <label class="block text-gray-700 mb-2">Escolha as colunas:</label>
    <div id="columnsContainer" class="grid grid-cols-2 gap-2 mb-4"></div>

    <!-- Botão -->
    <button id="convertBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
      Converter e Baixar TXT
    </button>

    <!-- Preview -->
    <div id="previewContainer" class="mt-6 hidden">
      <h3 class="text-lg font-semibold mb-2 text-gray-700">Prévia dos dados</h3>
      <table class="w-full border border-gray-300 text-sm text-left">
        <thead id="previewHead" class="bg-gray-200"></thead>
        <tbody id="previewBody"></tbody>
      </table>
    </div>
  </div>

  <script>
    let workbookGlobal = null;
    let currentRows = [];

    document.getElementById("fileInput").addEventListener("change", function (e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (evt) {
        const data = new Uint8Array(evt.target.result);
        workbookGlobal = XLSX.read(data, { type: "array" });

        // Preenche as abas
        const sheetSelect = document.getElementById("sheetSelect");
        sheetSelect.innerHTML = "";
        workbookGlobal.SheetNames.forEach((name, idx) => {
          const option = document.createElement("option");
          option.value = name;
          option.textContent = name;
          if (idx === 0) option.selected = true;
          sheetSelect.appendChild(option);
        });

        carregarColunas();
      };
      reader.readAsArrayBuffer(file);
    });

    document.getElementById("sheetSelect").addEventListener("change", carregarColunas);

    function carregarColunas() {
      const sheetName = document.getElementById("sheetSelect").value;
      const sheet = workbookGlobal.Sheets[sheetName];
      const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

      // Ignora linhas de cabeçalho vazias ou mescladas
      const headerRow = rows.find(r => r.some(cell => cell !== undefined && cell !== null && cell !== ""));
      currentRows = rows.slice(rows.indexOf(headerRow) + 1);

      const container = document.getElementById("columnsContainer");
      container.innerHTML = "";

      if (headerRow) {
        headerRow.forEach((col, idx) => {
          if (col) {
            const label = document.createElement("label");
            label.className = "flex items-center space-x-2";
            label.innerHTML = `<input type="checkbox" value="${idx}" checked class="columnCheck"> <span>${col}</span>`;
            container.appendChild(label);
          }
        });
      }

      mostrarPreview();
    }

    function mostrarPreview() {
      const checks = document.querySelectorAll(".columnCheck:checked");
      const colIndexes = Array.from(checks).map(c => parseInt(c.value));

      const previewHead = document.getElementById("previewHead");
      const previewBody = document.getElementById("previewBody");
      const previewContainer = document.getElementById("previewContainer");

      previewHead.innerHTML = "";
      previewBody.innerHTML = "";

      if (colIndexes.length === 0 || currentRows.length === 0) {
        previewContainer.classList.add("hidden");
        return;
      }

      // Cabeçalho
      const headerRow = document.createElement("tr");
      colIndexes.forEach(i => {
        const th = document.createElement("th");
        th.className = "border px-2 py-1";
        th.textContent = i;
        headerRow.appendChild(th);
      });
      previewHead.appendChild(headerRow);

      // Linhas
      currentRows.slice(0, 10).forEach(row => {
        if (row.some(cell => cell !== undefined && cell !== null && cell !== "")) {
          const tr = document.createElement("tr");
          colIndexes.forEach(i => {
            const td = document.createElement("td");
            td.className = "border px-2 py-1";
            td.textContent = row[i] ?? "";
            tr.appendChild(td);
          });
          previewBody.appendChild(tr);
        }
      });

      previewContainer.classList.remove("hidden");
    }

    document.getElementById("columnsContainer").addEventListener("change", mostrarPreview);

    document.getElementById("convertBtn").addEventListener("click", function () {
      const checks = document.querySelectorAll(".columnCheck:checked");
      const colIndexes = Array.from(checks).map(c => parseInt(c.value));

      if (colIndexes.length === 0) {
        alert("Selecione ao menos uma coluna!");
        return;
      }

      let txtContent = "";
      currentRows.forEach(row => {
        if (row.some(cell => cell !== undefined && cell !== null && cell !== "")) {
          const line = colIndexes.map(i => row[i] ?? "").join(";");
          if (line.replace(/;/g, "").trim() !== "") {
            txtContent += line + "\n";
          }
        }
      });

      const sheetName = document.getElementById("sheetSelect").value;
      const blob = new Blob([txtContent], { type: "text/plain;charset=utf-8" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = sheetName + "_resultado.txt";
      link.click();
    });
  </script>
</body>
</html>
