<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Excel ➝ TXT (colunas selecionáveis)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
  <div class="bg-white shadow-lg rounded-2xl p-8 w-full max-w-5xl">
    <h1 class="text-2xl font-bold text-gray-800 mb-6 text-center">Excel ➝ TXT (somente dados)</h1>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- Coluna esquerda: controles -->
      <div class="space-y-4">
        <!-- Upload -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Selecione a planilha:</label>
          <input id="fileInput" type="file" accept=".xlsx,.xls"
                 class="w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-400 focus:outline-none" />
        </div>

        <!-- Abas -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Escolha a aba:</label>
          <select id="sheetSelect"
                  class="w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-400 focus:outline-none">
          </select>
        </div>

        <!-- Colunas -->
        <div id="columnsContainer" class="hidden">
          <div class="flex items-center justify-between mb-2">
            <label class="block text-sm font-medium text-gray-700">Escolha as colunas:</label>
            <div class="space-x-2 text-xs">
              <button id="checkAll" class="px-2 py-1 border rounded hover:bg-gray-50">Marcar tudo</button>
              <button id="uncheckAll" class="px-2 py-1 border rounded hover:bg-gray-50">Desmarcar tudo</button>
            </div>
          </div>
          <div id="columnsList" class="grid grid-cols-2 gap-2"></div>
        </div>

        <!-- Exportar -->
        <button id="convertBtn"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 rounded-lg transition">
          Converter e Baixar TXT
        </button>

        <!-- Contador -->
        <div id="counter" class="text-sm text-gray-600"></div>
      </div>

      <!-- Coluna direita: preview -->
      <div>
        <h2 class="text-lg font-semibold text-gray-800 mb-2">Pré-visualização (primeiras 10 linhas)</h2>
        <div class="overflow-x-auto border border-gray-200 rounded-lg">
          <table class="min-w-full text-sm text-left text-gray-700" id="previewTable">
            <thead class="bg-gray-100" id="previewHead"></thead>
            <tbody id="previewBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    let workbookGlobal = null;
    let allRows = [];           // todas as linhas da aba (matriz)
    let headerRowIndex = 0;     // índice da linha de cabeçalho detectada
    let headerLabels = [];      // nomes das colunas (linha de cabeçalho)
    const SEP = ";";            // separador fixo (requisito)

    // Util: obter conjunto de linhas que possuem células mescladas
    function getMergedRowsSet(sheet) {
      const mergedSet = new Set();
      const merges = sheet["!merges"] || [];
      merges.forEach(m => {
        for (let r = m.s.r; r <= m.e.r; r++) mergedSet.add(r);
      });
      return mergedSet;
    }

    // Util: verifica se célula tem "conteúdo real"
    function hasValue(x) {
      return x !== undefined && x !== null && String(x).trim() !== "";
    }

    // Encontrar a linha de cabeçalho ignorando linhas mescladas
    function findHeaderRowIgnoringMerges(rows, mergedRowsSet) {
      for (let i = 0; i < rows.length; i++) {
        if (mergedRowsSet.has(i)) continue; // pula qualquer linha tocada por merge
        const row = rows[i] || [];
        // Heurística: precisa ter ao menos 2 células não vazias
        const nonEmptyCount = row.reduce((acc, c) => acc + (hasValue(c) ? 1 : 0), 0);
        if (nonEmptyCount >= 2) {
          return i;
        }
      }
      return 0; // fallback
    }

    // Carregar lista de abas após upload
    document.getElementById("fileInput").addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (ev) => {
        const data = new Uint8Array(ev.target.result);
        workbookGlobal = XLSX.read(data, { type: "array" });

        const sheetSelect = document.getElementById("sheetSelect");
        sheetSelect.innerHTML = "";
        workbookGlobal.SheetNames.forEach((name, idx) => {
          const opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name;
          if (idx === 0) opt.selected = true;
          sheetSelect.appendChild(opt);
        });

        // Carrega automaticamente a primeira aba
        loadSheet(sheetSelect.value);
      };
      reader.readAsArrayBuffer(file);
    });

    // Troca de aba
    document.getElementById("sheetSelect").addEventListener("change", function () {
      loadSheet(this.value);
    });

    function loadSheet(sheetName) {
      if (!workbookGlobal) return;
      const sheet = workbookGlobal.Sheets[sheetName];
      allRows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

      const mergedRowsSet = getMergedRowsSet(sheet);
      headerRowIndex = findHeaderRowIgnoringMerges(allRows, mergedRowsSet);

      headerLabels = (allRows[headerRowIndex] || []).map(v => (hasValue(v) ? String(v) : ""));

      // Monta checkboxes das colunas com nomes válidos
      const columnsList = document.getElementById("columnsList");
      const columnsContainer = document.getElementById("columnsContainer");
      columnsList.innerHTML = "";

      headerLabels.forEach((label, idx) => {
        if (label) {
          const wrap = document.createElement("label");
          wrap.className = "flex items-center space-x-2";
          wrap.innerHTML = `
            <input type="checkbox" class="colCheckbox" value="${idx}" checked>
            <span>${label}</span>
          `;
          columnsList.appendChild(wrap);
        }
      });

      columnsContainer.classList.toggle("hidden", columnsList.children.length === 0);

      // Eventos de marcar/desmarcar
      document.getElementById("checkAll").onclick = () => {
        document.querySelectorAll(".colCheckbox").forEach(cb => cb.checked = true);
        updatePreviewAndCounter();
      };
      document.getElementById("uncheckAll").onclick = () => {
        document.querySelectorAll(".colCheckbox").forEach(cb => cb.checked = false);
        updatePreviewAndCounter();
      };
      columnsList.querySelectorAll(".colCheckbox").forEach(cb => {
        cb.addEventListener("change", updatePreviewAndCounter);
      });

      updatePreviewAndCounter();
    }

    function getSelectedColIndexes() {
      return Array.from(document.querySelectorAll(".colCheckbox:checked"))
                  .map(cb => parseInt(cb.value));
    }

    function updatePreviewAndCounter() {
      const selectedCols = getSelectedColIndexes();
      const previewHead = document.getElementById("previewHead");
      const previewBody = document.getElementById("previewBody");
      const counter = document.getElementById("counter");

      previewHead.innerHTML = "";
      previewBody.innerHTML = "";

      if (selectedCols.length === 0 || allRows.length === 0) {
        counter.textContent = "";
        return;
      }

      // Cabeçalho do preview (apenas visual)
      const trHead = document.createElement("tr");
      selectedCols.forEach(idx => {
        const th = document.createElement("th");
        th.className = "px-3 py-2 border-b border-gray-200";
        th.textContent = headerLabels[idx] || `Col ${idx + 1}`;
        trHead.appendChild(th);
      });
      previewHead.appendChild(trHead);

      // Preencher até 10 linhas de dados (após o cabeçalho real)
      let shown = 0;
      let validCount = 0;
      for (let i = headerRowIndex + 1; i < allRows.length; i++) {
        const row = allRows[i] || [];
        // Considera válida se houver pelo menos um valor entre as colunas selecionadas
        const values = selectedCols.map(c => (row[c] !== undefined && row[c] !== null) ? row[c] : "");
        const hasAny = values.some(v => String(v).trim() !== "");
        if (!hasAny) continue;

        validCount++;
        if (shown < 10) {
          const tr = document.createElement("tr");
          values.forEach(v => {
            const td = document.createElement("td");
            td.className = "px-3 py-2 border-b border-gray-100";
            td.textContent = v;
            tr.appendChild(td);
          });
          previewBody.appendChild(tr);
          shown++;
        }
      }

      counter.textContent = `Linhas válidas a exportar: ${validCount.toLocaleString("pt-BR")}`;
    }

    // Exportar TXT (sem cabeçalho)
    document.getElementById("convertBtn").addEventListener("click", () => {
      if (!workbookGlobal) {
        alert("Selecione uma planilha primeiro!");
        return;
      }
      const selectedCols = getSelectedColIndexes();
      if (selectedCols.length === 0) {
        alert("Selecione pelo menos uma coluna!");
        return;
      }

      let out = "";
      for (let i = headerRowIndex + 1; i < allRows.length; i++) {
        const row = allRows[i] || [];
        const fields = selectedCols.map(c => (row[c] !== undefined && row[c] !== null) ? row[c] : "");
        // só grava se houver dado real na linha
        if (fields.some(v => String(v).trim() !== "")) {
          const line = fields.join(SEP);
          // evita linhas só de separador (ex: ";;")
          if (line.replace(new RegExp(SEP, "g"), "").trim() !== "") {
            out += line + "\n";
          }
        }
      }

      const sheetName = document.getElementById("sheetSelect").value || "resultado";
      const blob = new Blob([out], { type: "text/plain;charset=utf-8" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `${sheetName}_resultado.txt`;
      a.click();
    });
  </script>
</body>
</html>
