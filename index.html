<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Excel para TXT</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">

  <div class="bg-white shadow-lg rounded-2xl p-8 w-full max-w-5xl">
    <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Excel ➝ TXT</h2>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- Configurações -->
      <div class="space-y-4">
        <!-- Input arquivo -->
        <div>
          <label class="block text-sm font-medium text-gray-600 mb-1">Selecione a planilha:</label>
          <input type="file" id="fileInput" accept=".xlsx,.xls" 
                 class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-400 focus:outline-none" />
        </div>

        <!-- Select aba -->
        <div>
          <label for="sheetSelect" class="block text-sm font-medium text-gray-600 mb-1">Escolha a aba:</label>
          <select id="sheetSelect" 
                  class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-400 focus:outline-none">
          </select>
        </div>

        <!-- Colunas dinâmicas -->
        <div id="columnsContainer" class="hidden">
          <label class="block text-sm font-medium text-gray-600 mb-2">Escolha as colunas:</label>
          <div id="columnsList" class="grid grid-cols-2 gap-2"></div>
        </div>

        <!-- Botão -->
        <button id="convertBtn" 
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
          Converter e Baixar TXT
        </button>
      </div>

      <!-- Preview -->
      <div>
        <h3 class="text-lg font-semibold text-gray-700 mb-2">Pré-visualização (10 primeiras linhas)</h3>
        <div class="overflow-x-auto border border-gray-200 rounded-lg">
          <table class="min-w-full text-sm text-left text-gray-600" id="previewTable">
            <thead class="bg-gray-100 text-gray-700"></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    let workbookGlobal = null;
    let currentRows = [];
    let headerRowIndex = 0;

    // Quando carrega a planilha
    document.getElementById("fileInput").addEventListener("change", function (e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (evt) {
        const data = new Uint8Array(evt.target.result);
        workbookGlobal = XLSX.read(data, { type: "array" });

        // Preenche o select com as abas
        const sheetSelect = document.getElementById("sheetSelect");
        sheetSelect.innerHTML = "";
        workbookGlobal.SheetNames.forEach((name, idx) => {
          const option = document.createElement("option");
          option.value = name;
          option.textContent = name;
          if (idx === 0) option.selected = true;
          sheetSelect.appendChild(option);
        });

        // Carregar colunas da primeira aba por padrão
        loadColumns(workbookGlobal.SheetNames[0]);
      };
      reader.readAsArrayBuffer(file);
    });

    // Quando mudar a aba
    document.getElementById("sheetSelect").addEventListener("change", function () {
      const sheetName = this.value;
      loadColumns(sheetName);
    });

    // Função para encontrar a linha de cabeçalho válida
    function findHeaderRow(rows) {
      for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        const validCols = row.filter(col => col !== undefined && col !== null && col !== "").length;
        if (validCols >= 2) {
          return i;
        }
      }
      return 0;
    }

    // Função para carregar colunas
    function loadColumns(sheetName) {
      if (!workbookGlobal) return;

      const sheet = workbookGlobal.Sheets[sheetName];
      currentRows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

      if (currentRows.length === 0) return;

      headerRowIndex = findHeaderRow(currentRows);
      const headers = currentRows[headerRowIndex];
      const columnsList = document.getElementById("columnsList");
      const container = document.getElementById("columnsContainer");

      columnsList.innerHTML = "";
      headers.forEach((header, index) => {
        if (header !== undefined && header !== null && header !== "") {
          const div = document.createElement("div");
          div.className = "flex items-center space-x-2";
          div.innerHTML = `
            <input type="checkbox" class="colCheckbox" value="${index}" id="col${index}">
            <label for="col${index}" class="text-sm text-gray-700">${header}</label>
          `;
          columnsList.appendChild(div);
        }
      });

      container.classList.remove("hidden");

      // Atualiza preview ao marcar/desmarcar colunas
      columnsList.querySelectorAll(".colCheckbox").forEach(cb => {
        cb.addEventListener("change", updatePreview);
      });
    }

    // Atualizar preview
    function updatePreview() {
      const selectedCols = Array.from(document.querySelectorAll(".colCheckbox:checked"))
                               .map(cb => parseInt(cb.value));

      const previewHead = document.querySelector("#previewTable thead");
      const previewBody = document.querySelector("#previewTable tbody");

      previewHead.innerHTML = "";
      previewBody.innerHTML = "";

      if (selectedCols.length === 0) return;

      // Cabeçalho
      const headerRow = document.createElement("tr");
      selectedCols.forEach(idx => {
        const th = document.createElement("th");
        th.className = "px-3 py-2 border-b border-gray-200";
        th.textContent = currentRows[headerRowIndex][idx];
        headerRow.appendChild(th);
      });
      previewHead.appendChild(headerRow);

      // Primeiras 10 linhas de dados
      for (let i = headerRowIndex + 1; i < currentRows.length && i <= headerRowIndex + 10; i++) {
        const row = currentRows[i];
        if (!row) continue;
        const values = selectedCols.map(colIndex => row[colIndex] !== undefined ? row[colIndex] : "");
        if (values.join("").trim() === "") continue;

        const tr = document.createElement("tr");
        values.forEach(val => {
          const td = document.createElement("td");
          td.className = "px-3 py-2 border-b border-gray-100";
          td.textContent = val;
          tr.appendChild(td);
        });
        previewBody.appendChild(tr);
      }
    }

    // Converter e exportar
    document.getElementById("convertBtn").addEventListener("click", function () {
      if (!workbookGlobal) {
        alert("Selecione uma planilha primeiro!");
        return;
      }

      const selectedCols = Array.from(document.querySelectorAll(".colCheckbox:checked"))
                               .map(cb => parseInt(cb.value));

      if (selectedCols.length === 0) {
        alert("Selecione pelo menos uma coluna!");
        return;
      }

      let txtContent = "";
      currentRows.forEach((row, idx) => {
        if (idx <= headerRowIndex) return;

        const line = selectedCols.map(colIndex => row[colIndex] !== undefined ? row[colIndex] : "").join(";");
        if (line.replace(/;/g, "").trim() !== "") {
          txtContent += line + "\n";
        }
      });

      const blob = new Blob([txtContent], { type: "text/plain;charset=utf-8" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "resultado.txt";
      link.click();
    });
  </script>
</body>
</html>
